---
name: log-cache

templates:
  bpm.yml.erb: config/bpm.yml
  ca.crt.erb: config/certs/ca.crt
  log_cache.crt.erb: config/certs/log_cache.crt
  log_cache.key.erb: config/certs/log_cache.key
  indicators.yml.erb: config/indicators.yml
  prom_scraper_config.yml.erb: config/prom_scraper_config.yml
  metrics_ca.crt.erb: config/certs/metrics_ca.crt
  metrics.crt.erb: config/certs/metrics.crt
  metrics.key.erb: config/certs/metrics.key

packages:
- log-cache

provides:
- name: log-cache
  type: log-cache
  properties:
  - port
  - tls
  - disabled

consumes:
- name: log-cache
  type: log-cache

properties:

  append_node_addresses:
    description: "Array of log-cache instances to add to bosh links"

  prepend_node_addresses:
    description: "Array of log-cache instances to add to bosh links"

  port:
    description: "The port for the log-cache to listen on"
    default: 8080

  memory_limit_percent:
    description: "Percentage of system memory to use for the cache. Must be an integer."
    default: 50

  memory_limit_bytes:
    description: "Overrides memory_limit_percent with a specific size cache in bytes."

  max_per_source:
    description: "The maximum number of items stored in LogCache per source."
    default: 100000

  ingress_buffer_size:
    description: "The ingress buffer (diode) size in number of items. The size of the ingress buffer used when LogCache nodes send items between each other. In some cases, the buffer size must be risen in order to avoid ingress drops. Must be an integer."
    default: 10000

  ingress_buffer_read_batch_size:
    description: "The ingress buffer read batch size in number of items. The size of the ingress buffer read batch used when LogCache nodes send envelopes between each other. In some cases, the batch size must be risen in order to make place in the buffer faster and avoid ingress drops. Must be an integer."
    default: 100

  ingress_buffer_read_batch_interval:
    description: "The ingress buffer read batch interval in milliseconds. The interval in which the data will be read out from the ingress buffer used when LogCache nodes send envelopes between each other. In some cases, the batch read interval must be adjusted in order to make place in the buffer faster and avoid ingress drops. Must be an integer."
    default: 250

  truncation_interval:
    description: "The amount of time between log-cache checking if it needs to prune"
    default: "1s"

  prunes_per_gc:
    description: "Number of consecutive prunes to do before running garbage collection. Lowering the value increase CPU utilization"
    default: 3

  promql.query_timeout:
    description: "The maximum allowed runtime for a single PromQL query. Smaller timeouts are recommended."
    default: "10s"

  tls.ca_cert:
    description: "The Certificate Authority for log cache mutual TLS."
  tls.cert:
    description: "The client cert for log cache mutual TLS."
  tls.key:
    description: "The client private key for log cache mutual TLS."

  metrics.port:
    description: "The port for LogCache to bind a health endpoint"
    default: 6060
  metrics.ca_cert:
    description: "TLS CA cert to verify requests to metrics endpoint."
  metrics.cert:
    description: "TLS certificate for metrics server signed by the metrics CA"
  metrics.key:
    description: "TLS private key for metrics server signed by the metrics CA"
  metrics.server_name:
    description: "The server name used in the scrape configuration for the metrics endpoint"
  metrics.debug:
    description: "Enables go_ and process_ metrics along with a pprof endpoint"
    default: false
  metrics.pprof_port:
    description: "If debug metrics is enabled, pprof will start at this port, ideally set to something other then 0"
    default: 0

  disabled:
    default: false
    description: "Turns off log cache."

  logging.format.timestamp:
    description: "Format for timestamp in component logs. Valid values are 'deprecated' and 'rfc3339'."
    default: "deprecated"
